import { a, b } from './chunk-ZFWGYZ2Z.js';
import { Buffer } from 'buffer';

var O=o=>{var e,t,a,s,d,i,r,n;return {baseURI:o.baseURI,debug:(e=o.debug)!=null?e:!1,loading:(t=o.loading)!=null?t:!0,loadingText:(a=o.loadingText)!=null?a:"\u4E0A\u4F20\u4E2D...",header:(s=o.header)!=null?s:{},timeout:(d=o.timeout)!=null?d:0,name:(i=o.name)!=null?i:"file",formData:(r=o.formData)!=null?r:{},saveSuffixName:(n=o.saveSuffixName)!=null?n:"png"}};var f=o=>{uni.showLoading({title:o.title,mask:o.mask||!0});};function S(o,e,t){return {request:r=>{var m;t.debug&&console.warn(`\u3010LwuUploader Debug:\u8BF7\u6C42\u62E6\u622A\u3011${JSON.stringify(t)}`),t.loading&&f({title:(m=t.loadingText)!=null?m:"\u4E0A\u4F20\u4E2D..."});let n="";process.env.NODE_ENV!=="development"?n=t.baseURI.dev:n=t.baseURI.pro;let c=a(a({},t),r),p=`${n}${r.url}`;return c.url=p,r.before&&r.before(c),o.request(c)},response:r=>(t.debug&&console.warn(`\u3010LwuUploader Debug:\u54CD\u5E94\u62E6\u622A\u3011${JSON.stringify(r)}`),e.after&&e.after(r),r),fail:r=>(t.debug&&console.warn(`\u3010LwuUploader Debug:\u8BF7\u6C42\u62E6\u622A\u5931\u8D25\u3011${JSON.stringify(r)}`),r),complete:r=>{uni.hideLoading(),t.debug&&console.warn(`\u3010LwuUploader Debug:\u8BF7\u6C42\u62E6\u622A\u5B8C\u6210\u3011${JSON.stringify(r)}`);}}}var U=o=>/\.(png|jpeg|jpg|webp|gif)$/i.test(o);var h=class{constructor(e,t){console.log(t,"\u8BF7\u6C42\u914D\u7F6E"),this.config=t,this.options=e,this.timeout=(e==null?void 0:e.timeout)||1,this.maxSize=(e==null?void 0:e.maxSize)||5*1024*1024,this.securityToken="",this.accessKeyId="",this.accessKeySecret="",this.uploadDir=(e==null?void 0:e.uploadDir)||"";let a$1="";a$1=(t==null?void 0:t.baseURI.pro)||"",process.env.NODE_ENV!=="development"&&(a$1=(t==null?void 0:t.baseURI.dev)||""),this.uploadImageUrl=(e==null?void 0:e.uploadImageUrl)||a$1,this.formData=a(a({},t==null?void 0:t.formData),e.formData),this.getOOSByAC=()=>e==null?void 0:e.getOOSByAC(),this.getPolicyBase64=()=>e.getPolicyBase64?e.getPolicyBase64():"";}getSignature(e,t,a){return b(this,null,function*(){return yield a==null?void 0:a.getSignature(e,t)})}getOOSByACInfo(){return b(this,null,function*(){let{accessKeyId:e,accessKeySecret:t,securityToken:a}=yield this.getOOSByAC();this.accessKeyId=e,this.accessKeySecret=t,this.securityToken=a;})}getDocs(){return b(this,null,function*(){return (yield import('./package-P4BT6CER.js')).homepage})}getPolicyBase64Res(){let e=new Date;e.setHours(e.getHours()+this.timeout);let a={expiration:e.toISOString(),conditions:[["content-length-range",0,this.maxSize*1024*1024]]};return Buffer.from(JSON.stringify(a)).toString("base64")}getUploadParams(){return b(this,null,function*(){let e=this.getPolicyBase64Res(),t=yield this.getSignature(e,this.accessKeySecret,this.options);return {OSSAccessKeyId:this.accessKeyId,policy:e,signature:t,"x-oss-security-token":this.securityToken}})}uploadFile(e,t,a$1,s,d){return console.log(s,"\u5168\u5C40\u914D\u7F6E\u4FE1\u606F"),new Promise((i,r)=>b(this,null,function*(){var b$1,C;let n=`${yield this.getDocs()}/api/${d}.html#\u8BF7\u6C42\u53C2\u6570`;if(!e){r({code:1,msg:"\u6587\u4EF6\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A",docs:n});return}let c=t||this.uploadDir;if(!c){r({code:1,msg:"\u4E0A\u4F20\u76EE\u5F55\u4E0D\u80FD\u4E3A\u7A7A\uFF0C\u8BF7\u68C0\u67E5 `uploadDir` \u53C2\u6570\u662F\u5426\u8BBE\u7F6E",docs:n});return}if(!this.uploadImageUrl){r({code:1,msg:"\u4E0A\u4F20\u670D\u52A1\u5668\u57DF\u540D\u6216\u4E0A\u4F20\u7684\u7B2C\u4E09\u65B9OOS\u5730\u5740\u4E0D\u80FD\u4E3A\u7A7A\uFF0C\u8BF7\u68C0\u67E5 `uploadImageUrl` \u53C2\u6570\u6216 `baseURI` \u5168\u5C40\u53C2\u6570\u662F\u5426\u8BBE\u7F6E ",docs:n});return}let p=U(e)?e.split(".").pop():(b$1=a$1==null?void 0:a$1.saveSuffixName)!=null?b$1:s==null?void 0:s.saveSuffixName;if(!p){r({code:1,msg:"\u6587\u4EF6\u4FDD\u5B58\u540E\u7F00\u4E0D\u80FD\u4E3A\u7A7A\uFF0C\u8BF7\u68C0\u67E5 `saveSuffixName` \u53C2\u6570\u662F\u5426\u8BBE\u7F6E",docs:n});return}let m=`${Date.now()}_${Math.floor(Math.random()*1e6)}.${p}`;a$1!=null&&a$1.genarateFileName&&(m=yield a$1.genarateFileName());let w=`${this.uploadImageUrl}/${c}/${m}`,v=a(a({key:`${c}/${m}`,success_action_status:200},yield this.getUploadParams()),this.formData);s!=null&&s.loading&&f({title:s==null?void 0:s.loadingText});let D=uni.uploadFile({url:this.uploadImageUrl,filePath:e,name:"file",timeout:(C=s==null?void 0:s.timeout)!=null?C:a$1==null?void 0:a$1.timeout,formData:a({},v),complete:()=>{uni.hideLoading();},fail:g=>b(this,null,function*(){if(this.config&&this.config.debug&&console.warn(`\u3010LwuUpload Debug:\u7B2C\u4E09\u65B9oos\u8FD4\u56DE\u7ED3\u679C\u3011${JSON.stringify(g)}`),g.errMsg==="uploadFile:fail timeout"){r({code:504,msg:"\u4E0A\u4F20\u8D85\u65F6\uFF0C\u8BF7\u68C0\u67E5\u4E0A\u4F20\u914D\u7F6E `timeout`",data:g.data,docs:n});return}if(g.statusCode!==200){r({code:1,msg:"\u4E0A\u4F20\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",data:g.data,docs:n});return}r({code:1,msg:g.errMsg,data:g.data,docs:n});}),success:()=>b(this,null,function*(){i({code:0,msg:"success",data:{uploadTask:D,url:w,path:`/${c}/${m}`},docs:n});})});}))}},y=h;var x=class{constructor(e){this.globalConfig={baseURI:{pro:"",dev:""}};this.reqConfig={url:"",files:[],filePath:"",name:""};this.globalConfig=a({},O(e)),this.reqConfig=a({url:"",files:[],filePath:"",name:""},this.globalConfig);}config(e){return this.reqConfig=a(a({},this.reqConfig),e),this}setHeader(e){return this.reqConfig.header=a({},e),this}setFormData(e){return this.reqConfig.formData=a({},e),this}upload(e){let t=a(a({},this.reqConfig),e),a$1=S({request:i=>(e.url=i.url,i),response:i=>i},a({},t),this.globalConfig),s=a({},t.header),d=a({},t.formData);return a$1.request(t),uni.uploadFile({url:e.url,files:t.files,fileType:t.fileType,file:t.file,filePath:t.filePath,name:t.name,header:s,timeout:t.timeout,formData:d,success:i=>{a$1.response(i),e.success&&e.success(i);},fail:i=>{a$1.fail(i),e.fail&&e.fail(i);},complete:i=>{a$1.complete(i),e.complete&&e.complete(i);}})}uploadOOSSync(e){return b(this,null,function*(){let t=new y(e,a({baseURI:{pro:"",dev:""}},this.reqConfig));return yield t.getOOSByACInfo(),yield t.uploadFile(e.filePath,e.uploadDir,e,this.globalConfig,"uploadOOSSync")})}uploadOOS(e){let t=new y(e,a({baseURI:{pro:"",dev:""}},this.reqConfig));return new Promise((a,s)=>b(this,null,function*(){yield t.getOOSByACInfo(),a(t.uploadFile(e.filePath,e.uploadDir,e,this.globalConfig,"uploadOOS"));}))}};

export { x as Uploader };
